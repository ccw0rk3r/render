<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Слайдшоу в MP4</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#f5f5f5; color:#333; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
h1 { margin:20px; color:#111; }
.block { background:#fff; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,0.1); padding:20px; margin:10px 0; width:90%; max-width:900px; }
#dropzone { width:100%; height:200px; border:2px dashed #aaa; border-radius:15px; display:flex; align-items:center; justify-content:center; text-align:center; transition:border-color .3s, background .3s; cursor:pointer; }
#dropzone.dragover { border-color:#0af; background:#e0f7ff; }
.controls { display:flex; flex-wrap:wrap; gap:20px; align-items:center; justify-content:flex-start; margin-top:10px; }
.control { display:flex; flex-direction:column; align-items:flex-start; }
input[type=range] { width:150px; margin-top:5px; }
button { padding:10px 25px; background:#0af; border:none; border-radius:10px; cursor:pointer; color:#fff; font-weight:bold; transition:background .2s, transform .2s; margin-top:10px; }
button:hover { background:#08c; transform:scale(1.05); }
#progress { width:100%; margin-top:15px; height:15px; border-radius:10px; overflow:hidden; background:#ddd; }
#progress > div { height:100%; width:0%; background:#0af; transition:width .2s; }
</style>
</head>
<body>
<h1>Слайдшоу в MP4</h1>

<div class="block">
  <div id="dropzone">Перетащите сюда фото или <button id="selectFilesBtn">Выбрать файлы</button></div>
</div>

<div class="block">
  <div class="controls">
    <div class="control">
      <label>Фоновая музыка</label>
      <input type="file" id="bgAudioFile" accept="audio/*">
      <input type="range" id="bgVolume" min="0" max="1" step="0.01" value="0.5">
    </div>
    <div class="control">
      <label>Голос</label>
      <input type="file" id="voiceAudioFile" accept="audio/*">
      <input type="range" id="voiceVolume" min="0" max="1" step="0.01" value="0.7">
    </div>
  </div>
</div>

<div class="block">
  <button id="renderBtn">Собрать видео</button>
  <div id="progress"><div></div></div>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.0/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log:true });
const dropzone = document.getElementById('dropzone');
const selectFilesBtn = document.getElementById('selectFilesBtn');
const renderBtn = document.getElementById('renderBtn');
const bgAudioFileInput = document.getElementById('bgAudioFile');
const voiceAudioFileInput = document.getElementById('voiceAudioFile');
const bgVolumeInput = document.getElementById('bgVolume');
const voiceVolumeInput = document.getElementById('voiceVolume');
const progressBar = document.querySelector('#progress > div');

let images = [];
let bgAudioFile, voiceAudioFile;

dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', e=>{ dropzone.classList.remove('dragover'); });
dropzone.addEventListener('drop', e=>{
    e.preventDefault(); dropzone.classList.remove('dragover'); handleFiles(e.dataTransfer.files);
});

selectFilesBtn.addEventListener('click', ()=>{ fileInput.click(); });

const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.accept = 'image/*';
fileInput.multiple = true;
fileInput.addEventListener('change', ()=>{ handleFiles(fileInput.files); });

function handleFiles(fileList){
    const files = Array.from(fileList).filter(f=>f.type.startsWith('image/'));
    files.forEach((file,i)=>{
        images.push({file,name:`img${images.length+i}.png`});
    });
    dropzone.innerHTML = `${images.length} фото загружено или <button id="selectFilesBtn">Выбрать файлы</button>`;
    document.getElementById('selectFilesBtn').addEventListener('click', ()=>{ fileInput.click(); });
}

bgAudioFileInput.addEventListener('change', e=>{ bgAudioFile = e.target.files[0]; });
voiceAudioFileInput.addEventListener('change', e=>{ voiceAudioFile = e.target.files[0]; });

renderBtn.addEventListener('click', async ()=>{
    if(images.length===0) return alert('Добавьте фото!');
    if(!voiceAudioFile) return alert('Добавьте голосовое аудио!');
    progressBar.style.width='0%';
    if(!ffmpeg.isLoaded()) await ffmpeg.load();

    for(let img of images){
        ffmpeg.FS('writeFile', img.name, await fetchFile(img.file));
    }
    ffmpeg.FS('writeFile', 'voice.mp3', await fetchFile(voiceAudioFile));
    if(bgAudioFile) ffmpeg.FS('writeFile', 'bg.mp3', await fetchFile(bgAudioFile));

    let listTxt = images.map(img=>`file '${img.name}'\nduration 5`).join('\n');
    listTxt += `\nfile '${images[images.length-1].name}'`;
    ffmpeg.FS('writeFile', 'list.txt', listTxt);

    progressBar.style.width='10%';

    // Видео с zoompan
    await ffmpeg.run('-f','concat','-safe','0','-i','list.txt','-vf',"zoompan=z='if(lte(zoom,1.15),zoom+0.003,zoom)':d=125",' -r','25','video.mp4');

    progressBar.style.width='60%';

    let audioCmd = ['-i','video.mp4','-i','voice.mp3'];
    if(bgAudioFile){
        audioCmd.push('-i','bg.mp3','-filter_complex',`[1:a]volume=${voiceVolumeInput.value}[v];[2:a]volume=${bgVolumeInput.value}[b];[v][b]amix=inputs=2[a]`,'-map','0:v','-map','[a]');
    } else {
        audioCmd.push('-map','0:v','-map','1:a');
    }
    audioCmd.push('output.mp4');
    await ffmpeg.run(...audioCmd);

    progressBar.style.width='100%';

    const data = ffmpeg.FS('readFile','output.mp4');
    const url = URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
    const a = document.createElement('a'); a.href=url; a.download='slideshow.mp4'; a.click();
});
</script>
</body>
</html>
