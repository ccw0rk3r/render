<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Слайдшоу в MP4</title>
</head>
<body>
<h1>Слайдшоу в MP4</h1>

<div>
  <label>Фото:</label>
  <input type="file" id="photoFiles" accept="image/*" multiple>
</div>

<div>
  <label>Фоновая музыка:</label>
  <input type="file" id="bgAudioFile" accept="audio/*">
  <label>Громкость:</label>
  <input type="range" id="bgVolume" min="0" max="1" step="0.01" value="0.5">
</div>

<div>
  <label>Голос:</label>
  <input type="file" id="voiceAudioFile" accept="audio/*">
  <label>Громкость:</label>
  <input type="range" id="voiceVolume" min="0" max="1" step="0.01" value="0.7">
</div>

<div>
  <button id="renderBtn">Собрать видео</button>
</div>

<progress id="progress" value="0" max="1" style="width:100%; margin-top:10px;"></progress>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.0/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log:true });

const photoFilesInput = document.getElementById('photoFiles');
const bgAudioFileInput = document.getElementById('bgAudioFile');
const voiceAudioFileInput = document.getElementById('voiceAudioFile');
const bgVolumeInput = document.getElementById('bgVolume');
const voiceVolumeInput = document.getElementById('voiceVolume');
const renderBtn = document.getElementById('renderBtn');
const progressBar = document.getElementById('progress');

let images = [];
let bgAudioFile, voiceAudioFile;

photoFilesInput.addEventListener('change', e => { images = Array.from(e.target.files); });
bgAudioFileInput.addEventListener('change', e => { bgAudioFile = e.target.files[0]; });
voiceAudioFileInput.addEventListener('change', e => { voiceAudioFile = e.target.files[0]; });

renderBtn.addEventListener('click', async ()=>{
    if(images.length===0) return alert('Добавьте фото!');
    if(!voiceAudioFile) return alert('Добавьте голосовое аудио!');

    progressBar.value = 0;
    if(!ffmpeg.isLoaded()) await ffmpeg.load();

    // Загружаем фото
    for(let i=0;i<images.length;i++){
        ffmpeg.FS('writeFile', `img${i}.png`, await fetchFile(images[i]));
    }
    ffmpeg.FS('writeFile', 'voice.mp3', await fetchFile(voiceAudioFile));
    if(bgAudioFile) ffmpeg.FS('writeFile', 'bg.mp3', await fetchFile(bgAudioFile));

    // Список фото для ffmpeg
    let listTxt = images.map((img,i)=>`file 'img${i}.png'\nduration 5`).join('\n');
    listTxt += `\nfile 'img${images.length-1}.png'`;
    ffmpeg.FS('writeFile', 'list.txt', listTxt);

    progressBar.value = 0.1;

    // Видео с увеличением
    await ffmpeg.run('-f','concat','-safe','0','-i','list.txt','-vf',"zoompan=z='if(lte(zoom,1.15),zoom+0.003,zoom)':d=125",' -r','25','video.mp4');

    progressBar.value = 0.6;

    // Добавляем аудио
    let audioCmd = ['-i','video.mp4','-i','voice.mp3'];
    if(bgAudioFile){
        audioCmd.push('-i','bg.mp3','-filter_complex',`[1:a]volume=${voiceVolumeInput.value}[v];[2:a]volume=${bgVolumeInput.value}[b];[v][b]amix=inputs=2[a]`,'-map','0:v','-map','[a]');
    } else {
        audioCmd.push('-map','0:v','-map','1:a');
    }
    audioCmd.push('output.mp4');
    await ffmpeg.run(...audioCmd);

    progressBar.value = 1;

    const data = ffmpeg.FS('readFile','output.mp4');
    const url = URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
    const a = document.createElement('a'); a.href=url; a.download='slideshow.mp4'; a.click();
});
</script>
</body>
</html>
